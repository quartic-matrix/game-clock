<html>
  <body>

    <pre id="received"></pre>

    <svg id="svg-area" width="100" height="1000" xmlns="http://www.w3.org/2000/svg">
      <g
        id="down-time-button">
        <rect
            id="down-time-rect"
            class="button-rect"
            rx="5"
            ry="5"
            y="2.5000043"
            x="2.5"
            height="80"
            width="80"
            style="opacity:1;vector-effect:none;fill:#75758a;fill-opacity:0.5;stroke:#5c5c5c;stroke-width:5;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1" />
        <text
            id="down-time-label-text"
            y="29.096361"
            x="41.852322"
            style="font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:11.28888893px;line-height:1.25;font-family:'Segoe UI';-inkscape-font-specification:'Segoe UI';text-align:center;letter-spacing:0px;word-spacing:0px;text-anchor:middle;fill:#000000;fill-opacity:1;stroke:none;stroke-width:0.26458332"
            xml:space="preserve"><tspan
              id="down-time-label"
              class="button-label"
              style="font-size:11.28888893px;text-align:center;text-anchor:middle;stroke-width:0.26458332"
              y="29.096361"
              x="41.852322">Down time</tspan></text>
        <text
            id="down-time-time-text"
            y="54.624832"
            x="42.496555"
            style="font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:16.93333244px;line-height:1.25;font-family:'Segoe UI';-inkscape-font-specification:'Segoe UI';text-align:center;letter-spacing:0px;word-spacing:0px;text-anchor:middle;fill:#000000;fill-opacity:1;stroke:none;stroke-width:0.26458332"
            xml:space="preserve"><tspan
              style="font-size:16.93333244px;text-align:center;text-anchor:middle;stroke-width:0.26458332"
              y="54.624832"
              x="42.496555"
              id="down-time-time"
              class="timer">00:00:00</tspan></text>
      </g>
    </svg>

    <script src="deploy/webrtc-swarm.js"></script> 
    <script>
      setInterval(updateActiveTimer, 1000);

      document.addEventListener("onload",init(),false);


      function init() {
        document.getElementById("down-time-time").innerHTML = "00:12:34";
        
        let colours = generateHslaColors(70, 50, 1.0, 6);

        for (var i = 0; i < colours.length; ++i) {
          cloneButton(i, colours[i]);
        };

        setupButton(document.getElementById("down-time-button"));
      }

      var activeTimer = document.getElementById("down-time-time");
      function updateActiveTimer() {
        if (!activeTimer) {
          return;
        }
        ++activeTimer.time;
        activeTimer.innerHTML = ":" + activeTimer.time;
      }

      function updateIds(element, i) {
        element.id = element.id.replace("down-time", "my-"+i);
        var children = [].slice.call(element.children);
        children.forEach(function (child) { updateIds(child, i); });
      }

      function setupButton(button) {
        var timer = button.querySelector(".timer")
        timer.time = 0;
        button.addEventListener("click", function() { switchTo(button); });
      }

      function cloneButton(i, colour) {
        var newButton = document.getElementById("down-time-button").cloneNode(true);
        updateIds(newButton, i);

        var move = "translate("+0+","+ (100+i*100) +")";
        newButton.setAttribute("transform", move);
        newButton.querySelector(".button-rect").style.fill = colour;
        setupButton(newButton);
        changeButtonName(newButton, i); 
        document.getElementById("svg-area").appendChild(newButton);
      }

      function generateHslaColors (saturation, lightness, alpha, amount) {
        let colors = []
        let huedelta = Math.trunc(360 / amount)

        for (let i = 0; i < amount; i++) {
          let hue = i * huedelta
          colors.push(`hsla(${hue},${saturation}%,${lightness}%,${alpha})`)
        }

        return colors
      }

      function changeButtonName(button, i) {
        button.querySelector(".button-label").innerHTML = "Button " + i;
      }

      if (true) {
        var sw = new WebRTCSwarm('swarm-example', ['https://quartic-matrix-signalhub.herokuapp.com/'])
        var isMyFirstConnection = true;

        if (!sw.WEBRTC_SUPPORT) {

        }

        sw.on('connect', function (peer, id) {
          console.log('connected to a new peer:', id)
          console.log('total peers:', sw.peers.length)

          peer.on('error', function (err) { 
            console.log('error', err); 
          })
          
          peer.on('data', receive);

          if (isMyFirstConnection) {
            isMyFirstConnection = false;
            if (!peer.initiator) {
              var data = {type:"requestUpdate"};
              var json = JSON.stringify(data);
              peer.send(json);
            }
          }
        })

        sw.on('disconnect', function (peer, id) {
          console.log('disconnected from a peer:', id)
          console.log('total peers:', sw.peers.length)
        })

        function switchTo(button) {
          var timer = button.querySelector(".timer")
          var data = {type:"update", activeTimerId:timer.id};

          pushTimerTimes(data);
          
          broadcast(data);
        }

        function pushTimerTimes(data) {
          data.timerTimes = [];
          return document.querySelectorAll(".timer").forEach(function (timer) {
            var timerTime = {id:timer.id, time:timer.time};
            data.timerTimes.push(timerTime);
          });
        }

        function broadcast(data) {
          var json = JSON.stringify(data);
          receive(json);
          sw.peers.forEach(function (peer) {
            peer.send(json);
          });
        }

        function receive(json) {
          document.getElementById("received").innerHTML = json;
          var data = JSON.parse(json);
          switch (data.type) {
            case "requestUpdate": {
              var dataToSend = {type:"update", activeTimerId:activeTimer.id};
              pushTimerTimes(dataToSend);
              broadcast(dataToSend);
              break;
            }
            case "update": {
              doUpdate(data);
              break;
            }
          }
        }

        function doUpdate(data) {
          activeTimer = document.getElementById(data.activeTimerId);
          data.timerTimes.forEach(function (timerTime) {
            timer = document.getElementById(timerTime.id);
            timer.time = timerTime.time;
            timer.innerHTML = ":" + timer.time;
          }); 
        }
      }
    </script> 
  </body>
</html>